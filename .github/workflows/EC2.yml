name: Entrega continua

on:
    workflow_call:

jobs:

    EC2:
        runs-on: ubuntu-latest
        steps:
        - name: Download a Build Artifact
          uses: actions/download-artifact@v4.1.8 # actions/download-artifact@v3.0.0
          with:
        # Artifact name
            name: programa
        - uses: actions/checkout@v4.1.7 # actions/checkout@v3

        - name: Deploy to Staging server
          uses: easingthemes/ssh-deploy@main
          with:
            SSH_PRIVATE_KEY: ${{ secrets.SSH_PRIVATE_KEY }}
            REMOTE_HOST: ${{ secrets.REMOTE_HOST }} 
            REMOTE_USER: ${{ secrets.REMOTE_USER }}
            TARGET: /home/${{ secrets.REMOTE_USER }}
            EXCLUDE: "postgres-data"

        - name: executing remote ssh commands
          # uses: appleboy/ssh-action@master
          # with:
          #   host: ${{ secrets.REMOTE_HOST }}
          #   username: ${{ secrets.REMOTE_USER }}
          #   key: ${{ secrets.SSH_PRIVATE_KEY }}
          #   port: 22
          #   script: |
          #     echo ${{ secrets.DBHOST }}
          #     export DBHOST=${{ secrets.DBHOST }}
          #     echo ${{ secrets.DBUSER }}
          #     export DBUSER=${{ secrets.DBUSER }}
          #     echo ${{ secrets.DBPASSWORD }}
          #     export DBPASSWORD=${{ secrets.DBPASSWORD }}
          #     echo ${{ secrets.DBNAME }}
          #     export DBNAME=${{ secrets.DBNAME }}
          #     echo ${{ secrets.DBPORT }}
          #     export DBPORT=${{ secrets.DBPORT }}
          #     export PORT=8000
          #     chmod +x main.go
          #     go run ./main.go > nohup.out 2> nohup.err < /dev/null &
          uses: fify/ssh-action@master
          with:
            command: |
              cd /home/ec2-user
              ls -a
            host: ${{ secrets.REMOTE_HOST }}
            user: ${{ secrets.REMOTE_USER }}
            key: ${{ secrets.SSH_PRIVATE_KEY }}

